<!DOCTYPE html>
<html class="writer-html5" lang="zh" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>openEuler-20.03-LTS-SP3_Rocky - OpenStack SIG Doc</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "openEuler-20.03-LTS-SP3_Rocky";
        var mkdocs_page_input_path = "install/openEuler-20.03-LTS-SP3/OpenStack-rocky.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> OpenStack SIG Doc
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" title="在此输入需要搜索的内容" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航栏">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">OpenStack SIG</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">贡献指导</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../contribute/rpm-packaging-reference/">RPM开发流程</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">安装指导</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../devstack/">devstack</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openEuler-20.03-LTS-SP2/OpenStack-queens/">openEuler-20.03-LTS-SP2_Queens</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openEuler-20.03-LTS-SP2/OpenStack-rocky/">openEuler-20.03-LTS-SP2_Rocky</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../OpenStack-queens/">openEuler-20.03-LTS-SP3_Queens</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">openEuler-20.03-LTS-SP3_Rocky</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#openstack">OpenStack 简介</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_1">准备环境</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#openstack-yum">OpenStack yum源配置</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_2">环境配置</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#sql-database">安装 SQL DataBase</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#rabbitmq">安装 RabbitMQ</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#memcached">安装 Memcached</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#openstack_1">安装 OpenStack</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#keystone">Keystone 安装</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#glance">Glance 安装</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../OpenStack-train/">openEuler-20.03-LTS-SP3_Train</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openEuler-20.03-LTS-SP4/OpenStack-train/">openEuler-20.03-LTS-SP4_Train</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openEuler-21.09/OpenStack-wallaby/">openEuler-21.09_Wallaby</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openEuler-22.03-LTS/OpenStack-train/">openEuler-22.03-LTS_Train</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openEuler-22.03-LTS/OpenStack-wallaby/">openEuler-22.03-LTS_Wallaby</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openEuler-22.03-LTS-SP1/OpenStack-train/">openEuler-22.03-LTS-SP1_Train</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openEuler-22.03-LTS-SP1/OpenStack-wallaby/">openEuler-22.03-LTS-SP1_Wallaby</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openEuler-22.03-LTS-SP2/OpenStack-train/">openEuler-22.03-LTS-SP2_Train</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openEuler-22.03-LTS-SP2/OpenStack-wallaby/">openEuler-22.03-LTS-SP2_Wallaby</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openEuler-22.03-LTS-SP3/OpenStack-train/">openEuler-22.03-LTS-SP3_Train</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openEuler-22.03-LTS-SP3/OpenStack-wallaby/">openEuler-22.03-LTS-SP3_Wallaby</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openEuler-22.09/OpenStack-yoga/">openEuler-22.09_Yoga</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">测试报告</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../test/openEuler-20.03-LTS-SP2/">openEuler-20.03-LTS-SP2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../test/openEuler-20.03-LTS-SP3/">openEuler-20.03-LTS-SP3</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../test/openEuler-22.03-LTS/">openEuler-22.03-LTS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../test/openEuler-22.09/">openEuler-22.09</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">自研特性</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../spec/priority_vm/">虚拟机高低优先级</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="移动导航栏">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">OpenStack SIG Doc</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="文档"></a></li>
          <li class="breadcrumb-item">安装指导</li>
      <li class="breadcrumb-item active">openEuler-20.03-LTS-SP3_Rocky</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="openstack-rocky">OpenStack-Rocky 部署指南<a class="headerlink" href="#openstack-rocky" title="Permanent link">&para;</a></h1>
<div class="toc">
<ul>
<li><a href="#openstack-rocky">OpenStack-Rocky 部署指南</a><ul>
<li><a href="#openstack">OpenStack 简介</a></li>
<li><a href="#_1">准备环境</a><ul>
<li><a href="#openstack-yum">OpenStack yum源配置</a></li>
<li><a href="#_2">环境配置</a></li>
<li><a href="#sql-database">安装 SQL DataBase</a></li>
<li><a href="#rabbitmq">安装 RabbitMQ</a></li>
<li><a href="#memcached">安装 Memcached</a></li>
</ul>
</li>
<li><a href="#openstack_1">安装 OpenStack</a><ul>
<li><a href="#keystone">Keystone 安装</a></li>
<li><a href="#glance">Glance 安装</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_3">...</a></li>
<li><a href="#_4">...</a></li>
<li><a href="#_5">...</a></li>
<li><a href="#arm64">注意：如果您使用的环境是鲲鹏架构，请下载arm64版本的镜像。</a><ul>
<li><a href="#nova">Nova 安装</a></li>
<li><a href="#neutron">Neutron 安装</a></li>
<li><a href="#cinder">Cinder 安装</a></li>
<li><a href="#horizon">Horizon 安装</a></li>
<li><a href="#tempest">Tempest 安装</a></li>
<li><a href="#ironic">Ironic 安装</a></li>
<li><a href="#kolla">Kolla 安装</a></li>
<li><a href="#trove">Trove 安装</a></li>
<li><a href="#rally">Rally 安装</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="openstack">OpenStack 简介<a class="headerlink" href="#openstack" title="Permanent link">&para;</a></h2>
<p>OpenStack 是一个社区，也是一个项目。它提供了一个部署云的操作平台或工具集，为组织提供可扩展的、灵活的云计算。</p>
<p>作为一个开源的云计算管理平台，OpenStack 由 nova、cinder、neutron、glance、keystone、horizon 等几个主要的组件组合起来完成具体工作。OpenStack 支持几乎所有类型的云环境，项目目标是提供实施简单、可大规模扩展、丰富、标准统一的云计算管理平台。OpenStack 通过各种互补的服务提供了基础设施即服务（IaaS）的解决方案，每个服务提供 API 进行集成。</p>
<p>openEuler 20.03-LTS-SP3 版本官方认证的第三方 oepkg yum 源已经支持 Openstack-Rocky 版本，用户可以配置好 oepkg yum 源后根据此文档进行 OpenStack 部署。</p>
<h2 id="_1">准备环境<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h3 id="openstack-yum">OpenStack yum源配置<a class="headerlink" href="#openstack-yum" title="Permanent link">&para;</a></h3>
<p>配置 20.03-LTS-SP3 官方认证的第三方源 oepkg</p>
<pre class="highlight"><code class="language-shell">$ cat &lt;&lt; EOF &gt;&gt; /etc/yum.repos.d/OpenStack_Rocky.repo
[openstack_rocky]
name=OpenStack_Rocky
baseurl=https://repo.oepkgs.net/openEuler/rpm/openEuler-20.03-LTS-SP3/budding-openeuler/openstack/rocky/$basearch/
gpgcheck=0
enabled=1
EOF</code></pre>
<p><strong><em>注意</em></strong></p>
<p>如果环境启用了Epol源，需要提高rocky仓的优先级，设置priority=1：
<pre class="highlight"><code class="language-shell">$ cat &lt;&lt; EOF &gt;&gt; /etc/yum.repos.d/OpenStack_Rocky.repo
[openstack_rocky]
name=OpenStack_Rocky
baseurl=https://repo.oepkgs.net/openEuler/rpm/openEuler-20.03-LTS-SP3/budding-openeuler/openstack/rocky/$basearch/
gpgcheck=0
enabled=1
priority=1
EOF</code></pre></p>
<pre class="highlight"><code class="language-shell">$ yum clean all &amp;&amp; yum makecache</code></pre>
<h3 id="_2">环境配置<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>在<code>/etc/hosts</code>中添加controller信息，例如节点IP是<code>10.0.0.11</code>，则新增：</p>
<pre class="highlight"><code>10.0.0.11   controller</code></pre>
<h3 id="sql-database">安装 SQL DataBase<a class="headerlink" href="#sql-database" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>执行如下命令，安装软件包。</p>
<p><pre class="highlight"><code class="language-shell">$ yum install mariadb mariadb-server python2-PyMySQL</code></pre>
2. 创建并编辑 <code>/etc/my.cnf.d/openstack.cnf</code> 文件。</p>
<p>复制如下内容到文件，其中 bind-address 设置为控制节点的管理IP地址。
<pre class="highlight"><code class="language-ini">[mysqld]
bind-address = 10.0.0.11
default-storage-engine = innodb
innodb_file_per_table = on
max_connections = 4096
collation-server = utf8_general_ci
character-set-server = utf8</code></pre></p>
</li>
<li>
<p>启动 DataBase 服务，并为其配置开机自启动：</p>
<pre class="highlight"><code class="language-shell">$ systemctl enable mariadb.service
$ systemctl start mariadb.service</code></pre>
<h3 id="rabbitmq">安装 RabbitMQ<a class="headerlink" href="#rabbitmq" title="Permanent link">&para;</a></h3>
</li>
<li>
<p>执行如下命令，安装软件包。</p>
<pre class="highlight"><code class="language-shell">$ yum install rabbitmq-server</code></pre>
</li>
<li>
<p>启动 RabbitMQ 服务，并为其配置开机自启动。</p>
<p><pre class="highlight"><code class="language-shell">$ systemctl enable rabbitmq-server.service
$ systemctl start rabbitmq-server.service</code></pre>
3. 添加 OpenStack用户。</p>
<p><pre class="highlight"><code class="language-shell">$ rabbitmqctl add_user openstack RABBIT_PASS</code></pre>
4. 替换 RABBIT_PASS，为OpenStack用户设置密码</p>
</li>
<li>
<p>设置openstack用户权限，允许进行配置、写、读：</p>
<pre class="highlight"><code class="language-shell">$ rabbitmqctl set_permissions openstack ".*" ".*" ".*"</code></pre>
</li>
</ol>
<h3 id="memcached">安装 Memcached<a class="headerlink" href="#memcached" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>执行如下命令，安装依赖软件包。</p>
<p><pre class="highlight"><code class="language-shell">$ yum install memcached python2-memcached</code></pre>
2. 编辑 <code>/etc/sysconfig/memcached</code> 文件，添加以下内容</p>
<p><pre class="highlight"><code class="language-shell">OPTIONS="-l 127.0.0.1,::1,controller"</code></pre>
OPTIONS 修改为实际环境中控制节点的管理IP地址。</p>
</li>
<li>
<p>执行如下命令，启动 Memcached 服务，并为其配置开机启动。</p>
<pre class="highlight"><code class="language-shell">$ systemctl enable memcached.service
$ systemctl start memcached.service</code></pre>
</li>
</ol>
<h2 id="openstack_1">安装 OpenStack<a class="headerlink" href="#openstack_1" title="Permanent link">&para;</a></h2>
<h3 id="keystone">Keystone 安装<a class="headerlink" href="#keystone" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>以 root 用户访问数据库，创建 keystone 数据库并授权。</p>
<pre class="highlight"><code class="language-shell">$ mysql -u root -p</code></pre>
<p><pre class="highlight"><code class="language-sql">MariaDB [(none)]&gt; CREATE DATABASE keystone;
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' \
IDENTIFIED BY 'KEYSTONE_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' \
IDENTIFIED BY 'KEYSTONE_DBPASS';
MariaDB [(none)]&gt; exit</code></pre>
替换 KEYSTONE_DBPASS，为 Keystone 数据库设置密码</p>
</li>
<li>
<p>执行如下命令，安装软件包。</p>
<pre class="highlight"><code class="language-shell">$ yum install openstack-keystone httpd python2-mod_wsgi</code></pre>
</li>
<li>
<p>配置keystone，编辑 <code>/etc/keystone/keystone.conf</code> 文件。在[database]部分，配置数据库入口。在[token]部分，配置token provider</p>
<p><pre class="highlight"><code class="language-ini">[database]
connection = mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone
[token]
provider = fernet</code></pre>
替换KEYSTONE_DBPASS为Keystone数据库的密码</p>
</li>
<li>
<p>执行如下命令，同步数据库。</p>
<pre class="highlight"><code class="language-shell">su -s /bin/sh -c "keystone-manage db_sync" keystone</code></pre>
</li>
<li>
<p>执行如下命令，初始化Fernet密钥仓库。</p>
<pre class="highlight"><code class="language-shell">$ keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
$ keystone-manage credential_setup --keystone-user keystone --keystone-group keystone</code></pre>
</li>
<li>
<p>执行如下命令，启动身份服务。</p>
<p><pre class="highlight"><code class="language-shell">$ keystone-manage bootstrap --bootstrap-password ADMIN_PASS \
--bootstrap-admin-url http://controller:5000/v3/ \
--bootstrap-internal-url http://controller:5000/v3/ \
--bootstrap-public-url http://controller:5000/v3/ \
--bootstrap-region-id RegionOne</code></pre>
替换 ADMIN_PASS，为 admin 用户设置密码。</p>
</li>
<li>
<p>编辑 <code>/etc/httpd/conf/httpd.conf</code> 文件，配置Apache HTTP server</p>
<pre class="highlight"><code class="language-shell">$ vim /etc/httpd/conf/httpd.conf</code></pre>
<p>配置 ServerName 项引用控制节点，如下所示。
<pre class="highlight"><code>ServerName controller</code></pre></p>
<p>如果 ServerName 项不存在则需要创建。</p>
</li>
<li>
<p>执行如下命令，为 <code>/usr/share/keystone/wsgi-keystone.conf</code> 文件创建链接。</p>
<pre class="highlight"><code class="language-shell">$ ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/</code></pre>
</li>
<li>
<p>完成安装，执行如下命令，启动Apache HTTP服务。</p>
<pre class="highlight"><code class="language-shell">$ systemctl enable httpd.service
$ systemctl start httpd.service</code></pre>
</li>
<li>
<p>安装OpenStackClient</p>
<pre class="highlight"><code class="language-shell">$ yum install python2-openstackclient</code></pre>
</li>
<li>
<p>创建 OpenStack client 环境脚本</p>
<p>创建admin用户的环境变量脚本：</p>
<pre class="highlight"><code class="language-shell"># vim admin-openrc

export OS_PROJECT_DOMAIN_NAME=Default
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=ADMIN_PASS
export OS_AUTH_URL=http://controller:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2</code></pre>
<p>替换ADMIN_PASS为admin用户的密码, 与上述<code>keystone-manage bootstrap</code> 命令中设置的密码一致
 运行脚本加载环境变量：</p>
<pre class="highlight"><code class="language-shell">$ source admin-openrc</code></pre>
</li>
<li>
<p>分别执行如下命令，创建domain, projects, users, roles。</p>
<p>创建domain ‘example’：</p>
<pre class="highlight"><code class="language-shell">$ openstack domain create --description "An Example Domain" example</code></pre>
<p>注：domain ‘default’在 keystone-manage bootstrap 时已创建</p>
<p>创建project ‘service’：</p>
<pre class="highlight"><code class="language-shell">$ openstack project create --domain default --description "Service Project" service</code></pre>
<p>创建（non-admin）project ’myproject‘，user ’myuser‘ 和 role ’myrole‘，为‘myproject’和‘myuser’添加角色‘myrole’：</p>
<pre class="highlight"><code class="language-shell">$ openstack project create --domain default --description "Demo Project" myproject
$ openstack user create --domain default --password-prompt myuser
$ openstack role create myrole
$ openstack role add --project myproject --user myuser myrole</code></pre>
</li>
<li>
<p>验证</p>
<p>取消临时环境变量OS_AUTH_URL和OS_PASSWORD：</p>
<pre class="highlight"><code class="language-shell">$ unset OS_AUTH_URL OS_PASSWORD</code></pre>
<p>为admin用户请求token：</p>
<pre class="highlight"><code class="language-shell">$ openstack --os-auth-url http://controller:5000/v3 \
--os-project-domain-name Default --os-user-domain-name Default \
--os-project-name admin --os-username admin token issue</code></pre>
<p>为myuser用户请求token：</p>
<pre class="highlight"><code class="language-shell">$ openstack --os-auth-url http://controller:5000/v3 \
--os-project-domain-name Default --os-user-domain-name Default \
--os-project-name myproject --os-username myuser token issue</code></pre>
</li>
</ol>
<h3 id="glance">Glance 安装<a class="headerlink" href="#glance" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>创建数据库、服务凭证和 API 端点</p>
<p>创建数据库：</p>
<p>以 root 用户访问数据库，创建 glance 数据库并授权。</p>
<pre class="highlight"><code class="language-shell">$ mysql -u root -p</code></pre>
<pre class="highlight"><code class="language-sql">MariaDB [(none)]&gt; CREATE DATABASE glance;
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' \
IDENTIFIED BY 'GLANCE_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' \
IDENTIFIED BY 'GLANCE_DBPASS';
MariaDB [(none)]&gt; exit</code></pre>
<p>替换 GLANCE_DBPASS，为 glance 数据库设置密码。</p>
<pre class="highlight"><code class="language-shell">$ source admin-openrc</code></pre>
<p>执行以下命令，分别完成创建 glance 服务凭证、创建glance用户和添加‘admin’角色到用户‘glance’。</p>
<p><pre class="highlight"><code class="language-shell">$ openstack user create --domain default --password-prompt glance
$ openstack role add --project service --user glance admin
$ openstack service create --name glance --description "OpenStack Image" image</code></pre>
创建镜像服务API端点：</p>
<pre class="highlight"><code class="language-shell">$ openstack endpoint create --region RegionOne image public http://controller:9292
$ openstack endpoint create --region RegionOne image internal http://controller:9292
$ openstack endpoint create --region RegionOne image admin http://controller:9292</code></pre>
</li>
<li>
<p>安装和配置</p>
<p>安装软件包：</p>
<p><pre class="highlight"><code class="language-shell">$ yum install openstack-glance</code></pre>
配置glance：</p>
<p>编辑 <code>/etc/glance/glance-api.conf</code> 文件：</p>
<p>在[database]部分，配置数据库入口</p>
<p>在[keystone_authtoken] [paste_deploy]部分，配置身份认证服务入口</p>
<p>在[glance_store]部分，配置本地文件系统存储和镜像文件的位置</p>
<pre class="highlight"><code class="language-ini">[database]
# ...
connection = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance
[keystone_authtoken]
# ...
www_authenticate_uri  = http://controller:5000
auth_url = http://controller:5000
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = glance
password = GLANCE_PASS
[paste_deploy]
# ...
flavor = keystone
[glance_store]
# ...
stores = file,http
default_store = file
filesystem_store_datadir = /var/lib/glance/images/</code></pre>
<p>编辑 <code>/etc/glance/glance-registry.conf</code> 文件：</p>
<p>在[database]部分，配置数据库入口</p>
<p>在[keystone_authtoken] [paste_deploy]部分，配置身份认证服务入口</p>
<p>```ini
[database]</p>
<h1 id="_3">...<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h1>
<p>connection = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance
[keystone_authtoken]</p>
<h1 id="_4">...<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h1>
<p>www_authenticate_uri  = http://controller:5000
auth_url = http://controller:5000
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = glance
password = GLANCE_PASS
[paste_deploy]</p>
<h1 id="_5">...<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h1>
<p>flavor = keystone
 ```</p>
<p>其中，替换 GLANCE_DBPASS 为 glance 数据库的密码，替换 GLANCE_PASS 为 glance 用户的密码。</p>
<p>同步数据库：</p>
<p><pre class="highlight"><code class="language-shell">$ su -s /bin/sh -c "glance-manage db_sync" glance</code></pre>
启动镜像服务：</p>
<pre class="highlight"><code class="language-shell">$ systemctl enable openstack-glance-api.service openstack-glance-registry.service
$ systemctl start openstack-glance-api.service openstack-glance-registry.service</code></pre>
</li>
<li>
<p>验证</p>
<p>下载镜像
```shell
$ source admin-openrc</p>
<h1 id="arm64">注意：如果您使用的环境是鲲鹏架构，请下载arm64版本的镜像。<a class="headerlink" href="#arm64" title="Permanent link">&para;</a></h1>
<p>$ wget http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img
   ```</p>
<p>向Image服务上传镜像：</p>
<p><code>shell
$ glance image-create --name "cirros" --file cirros-0.4.0-x86_64-disk.img --disk-format qcow2 --container-format bare --visibility=public</code></p>
<p>确认镜像上传并验证属性：</p>
<p><code>shell
$ glance image-list</code></p>
<h3 id="nova">Nova 安装<a class="headerlink" href="#nova" title="Permanent link">&para;</a></h3>
</li>
<li>
<p>创建数据库、服务凭证和 API 端点</p>
<p>创建数据库：</p>
<p>作为root用户访问数据库，创建nova、nova_api、nova_cell0 数据库并授权</p>
<pre class="highlight"><code class="language-shell">$ mysql -u root -p</code></pre>
<p><pre class="highlight"><code class="language-SQL">MariaDB [(none)]&gt; CREATE DATABASE nova_api;
MariaDB [(none)]&gt; CREATE DATABASE nova;
MariaDB [(none)]&gt; CREATE DATABASE nova_cell0;
MariaDB [(none)]&gt; CREATE DATABASE placement;

MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'localhost' \
IDENTIFIED BY 'NOVA_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'%' \
IDENTIFIED BY 'NOVA_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' \
IDENTIFIED BY 'NOVA_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' \
IDENTIFIED BY 'NOVA_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova_cell0.* TO 'nova'@'localhost' \
IDENTIFIED BY 'NOVA_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova_cell0.* TO 'nova'@'%' \
IDENTIFIED BY 'NOVA_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON placement.* TO 'placement'@'localhost' \
IDENTIFIED BY 'PLACEMENT_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON placement.* TO 'placement'@'%' \
IDENTIFIED BY 'PLACEMENT_DBPASS';
MariaDB [(none)]&gt; exit</code></pre>
替换NOVA_DBPASS及PLACEMENT_DBPASS，为nova及placement数据库设置密码</p>
<p>执行如下命令，完成创建nova服务凭证、创建nova用户以及添加‘admin’角色到用户‘nova’。</p>
<pre class="highlight"><code class="language-shell">$ . admin-openrc
$ openstack user create --domain default --password-prompt nova
$ openstack role add --project service --user nova admin
$ openstack service create --name nova --description "OpenStack Compute" compute</code></pre>
<p>创建计算服务API端点：</p>
<pre class="highlight"><code class="language-shell">$ openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1
$ openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1
$ openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1</code></pre>
<p>创建placement用户并添加‘admin’角色到用户‘placement’：
<pre class="highlight"><code class="language-shell">$ openstack user create --domain default --password-prompt placement
$ openstack role add --project service --user placement admin</code></pre></p>
<p>创建placement服务凭证及API服务端点：
<pre class="highlight"><code class="language-shell">$ openstack service create --name placement --description "Placement API" placement
$ openstack endpoint create --region RegionOne placement public http://controller:8778
$ openstack endpoint create --region RegionOne placement internal http://controller:8778
$ openstack endpoint create --region RegionOne placement admin http://controller:8778</code></pre></p>
</li>
<li>
<p>安装和配置</p>
<p>安装软件包：</p>
<pre class="highlight"><code class="language-shell">$ yum install openstack-nova-api openstack-nova-conductor \
  openstack-nova-novncproxy openstack-nova-scheduler openstack-nova-compute \
  openstack-nova-placement-api openstack-nova-console</code></pre>
<p>配置nova：</p>
<p>编辑 <code>/etc/nova/nova.conf</code> 文件：</p>
<p>在[default]部分，启用计算和元数据的API，配置RabbitMQ消息队列入口，配置my_ip，启用网络服务neutron；</p>
<p>在[api_database] [database] [placement_database]部分，配置数据库入口；</p>
<p>在[api] [keystone_authtoken]部分，配置身份认证服务入口；</p>
<p>在[vnc]部分，启用并配置远程控制台入口；</p>
<p>在[glance]部分，配置镜像服务API的地址；</p>
<p>在[oslo_concurrency]部分，配置lock path；</p>
<p>在[placement]部分，配置placement服务的入口。</p>
<pre class="highlight"><code class="language-ini">[DEFAULT]
# ...
enabled_apis = osapi_compute,metadata
transport_url = rabbit://openstack:RABBIT_PASS@controller:5672/
my_ip = 10.0.0.11
use_neutron = true
firewall_driver = nova.virt.firewall.NoopFirewallDriver
compute_driver = libvirt.LibvirtDriver
instances_path = /var/lib/nova/instances/
[api_database]
# ...
connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api
[database]
# ...
connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova
[placement_database]
# ...
connection = mysql+pymysql://placement:PLACEMENT_DBPASS@controller/placement
[api]
# ...
auth_strategy = keystone
[keystone_authtoken]
# ...
www_authenticate_uri = http://controller:5000/
auth_url = http://controller:5000/
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = nova
password = NOVA_PASS
[vnc]
enabled = true
# ...
server_listen = $my_ip
server_proxyclient_address = $my_ip
novncproxy_base_url = http://controller:6080/vnc_auto.html
[glance]
# ...
api_servers = http://controller:9292
[oslo_concurrency]
# ...
lock_path = /var/lib/nova/tmp
[placement]
# ...
region_name = RegionOne
project_domain_name = Default
project_name = service
auth_type = password
user_domain_name = Default
auth_url = http://controller:5000/v3
username = placement
password = PLACEMENT_PASS
[neutron]
# ...
auth_url = http://controller:5000
auth_type = password
project_domain_name = Default
user_domain_name = Default
region_name = RegionOne
project_name = service
username = neutron
password = NEUTRON_PASS</code></pre>
<p>替换RABBIT_PASS为RabbitMQ中openstack账户的密码；</p>
<p>配置my_ip为控制节点的管理IP地址；</p>
<p>替换NOVA_DBPASS为nova数据库的密码；</p>
<p>替换PLACEMENT_DBPASS为placement数据库的密码；</p>
<p>替换NOVA_PASS为nova用户的密码；</p>
<p>替换PLACEMENT_PASS为placement用户的密码；</p>
<p>替换NEUTRON_PASS为neutron用户的密码；</p>
<p>编辑<code>/etc/httpd/conf.d/00-nova-placement-api.conf</code>，增加Placement API接入配置</p>
<pre class="highlight"><code class="language-xml">&lt;Directory /usr/bin&gt;
   &lt;IfVersion &gt;= 2.4&gt;
      Require all granted
   &lt;/IfVersion&gt;
   &lt;IfVersion &lt; 2.4&gt;
      Order allow,deny
      Allow from all
   &lt;/IfVersion&gt;
&lt;/Directory&gt;</code></pre>
<p>重启httpd服务：</p>
<pre class="highlight"><code class="language-shell">$ systemctl restart httpd</code></pre>
<p>同步nova-api数据库：</p>
<p><pre class="highlight"><code class="language-shell">$ su -s /bin/sh -c "nova-manage api_db sync" nova</code></pre>
注册cell0数据库：</p>
<p><pre class="highlight"><code class="language-shell">$ su -s /bin/sh -c "nova-manage cell_v2 map_cell0" nova</code></pre>
创建cell1 cell：</p>
<p><pre class="highlight"><code class="language-shell">$ su -s /bin/sh -c "nova-manage cell_v2 create_cell --name=cell1 --verbose" nova</code></pre>
同步nova数据库：</p>
<p><pre class="highlight"><code class="language-shell">$ su -s /bin/sh -c "nova-manage db sync" nova</code></pre>
验证cell0和cell1注册正确：</p>
<p><pre class="highlight"><code class="language-shell">su -s /bin/sh -c "nova-manage cell_v2 list_cells" nova</code></pre>
确定是否支持虚拟机硬件加速（x86架构）：</p>
<pre class="highlight"><code class="language-shell">$ egrep -c '(vmx|svm)' /proc/cpuinfo</code></pre>
<p>如果返回值为0则不支持硬件加速，需要配置libvirt使用QEMU而不是KVM：
<strong>注意：</strong> 如果是在ARM64的服务器上，还需要在配置<code>cpu_mode</code>为<code>custom</code>,<code>cpu_model</code>为<code>cortex-a72</code></p>
<p><pre class="highlight"><code class="language-ini"># vim /etc/nova/nova.conf
[libvirt]
# ...
virt_type = qemu
cpu_mode = custom
cpu_model = cortex-a72</code></pre>
如果返回值为1或更大的值，则支持硬件加速，不需要进行额外的配置</p>
<p><strong><em>注意</em></strong></p>
<p><strong>如果为arm64结构，还需要在<code>compute</code>节点执行以下命令</strong></p>
<pre class="highlight"><code class="language-shell">mkdir -p /usr/share/AAVMF
ln -s /usr/share/edk2/aarch64/QEMU_EFI-pflash.raw \
      /usr/share/AAVMF/AAVMF_CODE.fd
ln -s /usr/share/edk2/aarch64/vars-template-pflash.raw \
      /usr/share/AAVMF/AAVMF_VARS.fd
chown nova:nova /usr/share/AAVMF -R

vim /etc/libvirt/qemu.conf

nvram = ["/usr/share/AAVMF/AAVMF_CODE.fd:/usr/share/AAVMF/AAVMF_VARS.fd",
     "/usr/share/edk2/aarch64/QEMU_EFI-pflash.raw:/usr/share/edk2/aarch64/vars-template-pflash.raw"
]</code></pre>
<p>启动计算服务及其依赖项，并配置其开机启动：</p>
<p><pre class="highlight"><code class="language-shell">$ systemctl enable \
openstack-nova-api.service \
openstack-nova-scheduler.service \
openstack-nova-conductor.service \
openstack-nova-novncproxy.service
$ systemctl start \
openstack-nova-api.service \
openstack-nova-scheduler.service \
openstack-nova-conductor.service \
openstack-nova-novncproxy.service</code></pre>
<pre class="highlight"><code class="language-bash">$ systemctl enable libvirtd.service openstack-nova-compute.service
$ systemctl start libvirtd.service openstack-nova-compute.service</code></pre>
添加计算节点到cell数据库：</p>
<p>确认计算节点存在：</p>
<p><pre class="highlight"><code class="language-bash">$ . admin-openrc
$ openstack compute service list --service nova-compute</code></pre>
注册计算节点：</p>
<pre class="highlight"><code class="language-bash">$ su -s /bin/sh -c "nova-manage cell_v2 discover_hosts --verbose" nova</code></pre>
</li>
<li>
<p>验证</p>
<p><pre class="highlight"><code class="language-shell">$ . admin-openrc</code></pre>
列出服务组件，验证每个流程都成功启动和注册：</p>
<pre class="highlight"><code class="language-shell">$ openstack compute service list</code></pre>
<p>列出身份服务中的API端点，验证与身份服务的连接：</p>
<pre class="highlight"><code class="language-shell">$ openstack catalog list</code></pre>
<p>列出镜像服务中的镜像，验证与镜像服务的连接：</p>
<pre class="highlight"><code class="language-shell">$ openstack image list</code></pre>
<p>检查cells和placement API是否运作成功，以及其他必要条件是否已具备。</p>
<pre class="highlight"><code class="language-shell">$ nova-status upgrade check</code></pre>
<h3 id="neutron">Neutron 安装<a class="headerlink" href="#neutron" title="Permanent link">&para;</a></h3>
</li>
<li>
<p>创建数据库、服务凭证和 API 端点</p>
<p>创建数据库：</p>
<p>作为root用户访问数据库，创建 neutron 数据库并授权。</p>
<pre class="highlight"><code class="language-shell">$ mysql -u root -p</code></pre>
<p><pre class="highlight"><code class="language-sql">MariaDB [(none)]&gt; CREATE DATABASE neutron;
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' \
IDENTIFIED BY 'NEUTRON_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' \
IDENTIFIED BY 'NEUTRON_DBPASS';
MariaDB [(none)]&gt; exit</code></pre>
替换NEUTRON_DBPASS，为neutron数据库设置密码。</p>
<p><pre class="highlight"><code class="language-shell">$ . admin-openrc</code></pre>
执行如下命令，完成创建 neutron 服务凭证、创建neutron用户和添加‘admin’角色到‘neutron’用户操作。</p>
<p>创建neutron服务</p>
<p><pre class="highlight"><code class="language-shell">$ openstack user create --domain default --password-prompt neutron
$ openstack role add --project service --user neutron admin
$ openstack service create --name neutron --description "OpenStack Networking" network</code></pre>
创建网络服务API端点：</p>
<pre class="highlight"><code class="language-shell">$ openstack endpoint create --region RegionOne network public http://controller:9696
$ openstack endpoint create --region RegionOne network internal http://controller:9696
$ openstack endpoint create --region RegionOne network admin http://controller:9696</code></pre>
</li>
<li>
<p>安装和配置 Self-service 网络</p>
<p>安装软件包：</p>
<p><pre class="highlight"><code class="language-shell">$ yum install openstack-neutron openstack-neutron-ml2 \
openstack-neutron-linuxbridge ebtables ipset</code></pre>
配置neutron：</p>
<p>编辑 /etc/neutron/neutron.conf 文件：</p>
<p>在[database]部分，配置数据库入口；</p>
<p>在[default]部分，启用ml2插件和router插件，允许ip地址重叠，配置RabbitMQ消息队列入口；</p>
<p>在[default] [keystone]部分，配置身份认证服务入口；</p>
<p>在[default] [nova]部分，配置网络来通知计算网络拓扑的变化；</p>
<p>在[oslo_concurrency]部分，配置lock path。</p>
<pre class="highlight"><code class="language-ini">[database]
# ...
connection = mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron
[DEFAULT]
# ...
core_plugin = ml2
service_plugins = router
allow_overlapping_ips = true
transport_url = rabbit://openstack:RABBIT_PASS@controller
auth_strategy = keystone
notify_nova_on_port_status_changes = true
notify_nova_on_port_data_changes = true
[keystone_authtoken]
# ...
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = neutron
password = NEUTRON_PASS
[nova]
# ...
auth_url = http://controller:5000
auth_type = password
project_domain_name = Default
user_domain_name = Default
region_name = RegionOne
project_name = service
username = nova
password = NOVA_PASS
[oslo_concurrency]
# ...
lock_path = /var/lib/neutron/tmp</code></pre>
<p>替换NEUTRON_DBPASS为neutron数据库的密码；</p>
<p>替换RABBIT_PASS为RabbitMQ中openstack账户的密码；</p>
<p>替换NEUTRON_PASS为neutron用户的密码；</p>
<p>替换NOVA_PASS为nova用户的密码。</p>
<p>配置ML2插件：</p>
<p>编辑 /etc/neutron/plugins/ml2/ml2_conf.ini 文件：</p>
<p>在[ml2]部分，启用 flat、vlan、vxlan 网络，启用网桥及 layer-2 population 机制，启用端口安全扩展驱动；</p>
<p>在[ml2_type_flat]部分，配置 flat 网络为 provider 虚拟网络；</p>
<p>在[ml2_type_vxlan]部分，配置 VXLAN 网络标识符范围；</p>
<p>在[securitygroup]部分，配置允许 ipset。</p>
<p><pre class="highlight"><code class="language-ini"># vim /etc/neutron/plugins/ml2/ml2_conf.ini
[ml2]
# ...
type_drivers = flat,vlan,vxlan
tenant_network_types = vxlan
mechanism_drivers = linuxbridge,l2population
extension_drivers = port_security
[ml2_type_flat]
# ...
flat_networks = provider
[ml2_type_vxlan]
# ...
vni_ranges = 1:1000
[securitygroup]
# ...
enable_ipset = true</code></pre>
配置 Linux bridge 代理：</p>
<p>编辑 /etc/neutron/plugins/ml2/linuxbridge_agent.ini 文件：</p>
<p>在[linux_bridge]部分，映射 provider 虚拟网络到物理网络接口；</p>
<p>在[vxlan]部分，启用 vxlan 覆盖网络，配置处理覆盖网络的物理网络接口 IP 地址，启用 layer-2 population；</p>
<p>在[securitygroup]部分，允许安全组，配置 linux bridge iptables 防火墙驱动。</p>
<p><pre class="highlight"><code class="language-ini">[linux_bridge]
physical_interface_mappings = provider:PROVIDER_INTERFACE_NAME
[vxlan]
enable_vxlan = true
local_ip = OVERLAY_INTERFACE_IP_ADDRESS
l2_population = true
[securitygroup]
# ...
enable_security_group = true
firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</code></pre>
替换PROVIDER_INTERFACE_NAME为物理网络接口；</p>
<p>替换OVERLAY_INTERFACE_IP_ADDRESS为控制节点的管理IP地址。</p>
<p>配置Layer-3代理：</p>
<p>编辑 /etc/neutron/l3_agent.ini 文件：</p>
<p>在[default]部分，配置接口驱动为linuxbridge</p>
<p><pre class="highlight"><code class="language-ini">[DEFAULT]
# ...
interface_driver = linuxbridge</code></pre>
配置DHCP代理：</p>
<p>编辑 /etc/neutron/dhcp_agent.ini 文件：</p>
<p>在[default]部分，配置linuxbridge接口驱动、Dnsmasq DHCP驱动，启用隔离的元数据。</p>
<p><pre class="highlight"><code class="language-ini">[DEFAULT]
# ...
interface_driver = linuxbridge
dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
enable_isolated_metadata = true</code></pre>
配置metadata代理：</p>
<p>编辑 /etc/neutron/metadata_agent.ini 文件：</p>
<p>在[default]部分，配置元数据主机和shared secret。</p>
<p><pre class="highlight"><code class="language-ini">[DEFAULT]
# ...
nova_metadata_host = controller
metadata_proxy_shared_secret = METADATA_SECRET</code></pre>
替换METADATA_SECRET为合适的元数据代理secret。</p>
</li>
<li>
<p>配置计算服务</p>
<p>编辑 /etc/nova/nova.conf 文件：</p>
<p>在[neutron]部分，配置访问参数，启用元数据代理，配置secret。</p>
<pre class="highlight"><code class="language-ini">[neutron]
# ...
auth_url = http://controller:5000
auth_type = password
project_domain_name = Default
user_domain_name = Default
region_name = RegionOne
project_name = service
username = neutron
password = NEUTRON_PASS
service_metadata_proxy = true
metadata_proxy_shared_secret = METADATA_SECRET</code></pre>
<p>替换NEUTRON_PASS为neutron用户的密码；</p>
<p>替换METADATA_SECRET为合适的元数据代理secret。</p>
</li>
<li>
<p>完成安装</p>
<p>添加配置文件链接：</p>
<pre class="highlight"><code class="language-shell">$ ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini</code></pre>
<p>同步数据库：</p>
<pre class="highlight"><code class="language-shell">$ su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf \
--config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron</code></pre>
<p>重启计算API服务：</p>
<pre class="highlight"><code class="language-shell">$ systemctl restart openstack-nova-api.service</code></pre>
<p>启动网络服务并配置开机启动：</p>
<pre class="highlight"><code class="language-shell">$ systemctl enable neutron-server.service \
neutron-linuxbridge-agent.service neutron-dhcp-agent.service \
neutron-metadata-agent.service
$ systemctl start neutron-server.service \
neutron-linuxbridge-agent.service neutron-dhcp-agent.service \
neutron-metadata-agent.service
$ systemctl enable neutron-l3-agent.service
$ systemctl start neutron-l3-agent.service</code></pre>
</li>
<li>
<p>验证</p>
<p>列出代理验证 neutron 代理启动成功：</p>
<pre class="highlight"><code class="language-shell">$ openstack network agent list</code></pre>
</li>
</ol>
<h3 id="cinder">Cinder 安装<a class="headerlink" href="#cinder" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>创建数据库、服务凭证和 API 端点</p>
<p>创建数据库：</p>
<p>作为root用户访问数据库，创建cinder数据库并授权。</p>
<p><pre class="highlight"><code class="language-shell">$ mysql -u root -p
MariaDB [(none)]&gt; CREATE DATABASE cinder;
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'localhost' \
IDENTIFIED BY 'CINDER_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'%' \
IDENTIFIED BY 'CINDER_DBPASS';
MariaDB [(none)]&gt; exit</code></pre>
替换CINDER_DBPASS，为cinder数据库设置密码。</p>
<pre class="highlight"><code class="language-shell">$ source admin-openrc</code></pre>
<p>创建cinder服务凭证：</p>
<p>创建cinder用户</p>
<p>添加‘admin’角色到用户‘cinder’</p>
<p>创建cinderv2和cinderv3服务</p>
<p><pre class="highlight"><code class="language-shell">$ openstack user create --domain default --password-prompt cinder
$ openstack role add --project service --user cinder admin
$ openstack service create --name cinderv2 --description "OpenStack Block Storage" volumev2
$ openstack service create --name cinderv3 --description "OpenStack Block Storage" volumev3</code></pre>
创建块存储服务API端点：</p>
<pre class="highlight"><code class="language-shell">$ openstack endpoint create --region RegionOne volumev2 public http://controller:8776/v2/%\(project_id\)s
$ openstack endpoint create --region RegionOne volumev2 internal http://controller:8776/v2/%\(project_id\)s
$ openstack endpoint create --region RegionOne volumev2 admin http://controller:8776/v2/%\(project_id\)s
$ openstack endpoint create --region RegionOne volumev3 public http://controller:8776/v3/%\(project_id\)s
$ openstack endpoint create --region RegionOne volumev3 internal http://controller:8776/v3/%\(project_id\)s
$ openstack endpoint create --region RegionOne volumev3 admin http://controller:8776/v3/%\(project_id\)s</code></pre>
</li>
<li>
<p>安装和配置控制节点</p>
<p>安装软件包：</p>
<p><pre class="highlight"><code class="language-shell">$ yum install openstack-cinder</code></pre>
配置cinder：</p>
<p>编辑 <code>/etc/cinder/cinder.conf</code> 文件：</p>
<p>在[database]部分，配置数据库入口；</p>
<p>在[DEFAULT]部分，配置RabbitMQ消息队列入口，配置my_ip；</p>
<p>在[DEFAULT] [keystone_authtoken]部分，配置身份认证服务入口；</p>
<p>在[oslo_concurrency]部分，配置lock path。</p>
<p><pre class="highlight"><code class="language-ini">[database]
# ...
connection = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder
[DEFAULT]
# ...
transport_url = rabbit://openstack:RABBIT_PASS@controller
auth_strategy = keystone
my_ip = 10.0.0.11
[keystone_authtoken]
# ...
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = cinder
password = CINDER_PASS
[oslo_concurrency]
# ...
lock_path = /var/lib/cinder/tmp</code></pre>
替换CINDER_DBPASS为cinder数据库的密码；</p>
<p>替换RABBIT_PASS为RabbitMQ中openstack账户的密码；</p>
<p>配置my_ip为控制节点的管理IP地址；</p>
<p>替换CINDER_PASS为cinder用户的密码；</p>
<p>同步数据库：</p>
<p><pre class="highlight"><code class="language-shell">$ su -s /bin/sh -c "cinder-manage db sync" cinder</code></pre>
配置计算使用块存储：</p>
<p>编辑 /etc/nova/nova.conf 文件。</p>
<p><pre class="highlight"><code class="language-ini">[cinder]
os_region_name = RegionOne</code></pre>
完成安装：</p>
<p>重启计算API服务</p>
<p><pre class="highlight"><code class="language-shell">$ systemctl restart openstack-nova-api.service</code></pre>
启动块存储服务</p>
<pre class="highlight"><code class="language-shell">$ systemctl enable openstack-cinder-api.service openstack-cinder-scheduler.service
$ systemctl start openstack-cinder-api.service openstack-cinder-scheduler.service</code></pre>
</li>
<li>
<p>安装和配置存储节点（LVM）</p>
<p>安装软件包：</p>
<pre class="highlight"><code class="language-shell">$ yum install lvm2 device-mapper-persistent-data scsi-target-utils python2-keystone \
openstack-cinder-volume</code></pre>
<p>创建LVM物理卷 /dev/sdb：</p>
<p><pre class="highlight"><code class="language-shell">$ pvcreate /dev/sdb</code></pre>
创建LVM卷组 cinder-volumes：</p>
<p><pre class="highlight"><code class="language-shell">$ vgcreate cinder-volumes /dev/sdb</code></pre>
编辑 /etc/lvm/lvm.conf 文件：</p>
<p>在devices部分，添加过滤以接受/dev/sdb设备拒绝其他设备。</p>
<pre class="highlight"><code class="language-ini">devices {

# ...

filter = [ "a/sdb/", "r/.*/"]</code></pre>
<p>编辑 <code>/etc/cinder/cinder.conf</code> 文件：</p>
<p>在[lvm]部分，使用LVM驱动、cinder-volumes卷组、iSCSI协议和适当的iSCSI服务配置LVM后端。</p>
<p>在[DEFAULT]部分，启用LVM后端，配置镜像服务API的位置。</p>
<pre class="highlight"><code class="language-ini">[lvm]
volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver
volume_group = cinder-volumes
target_protocol = iscsi
target_helper = lioadm
[DEFAULT]
# ...
enabled_backends = lvm
glance_api_servers = http://controller:9292</code></pre>
<p><strong><em>注意</em></strong></p>
<p>当cinder使用tgtadm的方式挂卷的时候，要修改/etc/tgt/tgtd.conf，内容如下，保证tgtd可以发现cinder-volume的iscsi target。</p>
<p><pre class="highlight"><code>include /var/lib/cinder/volumes/*</code></pre>
完成安装：</p>
<pre class="highlight"><code class="language-shell">$ systemctl enable openstack-cinder-volume.service tgtd.service iscsid.service
$ systemctl start openstack-cinder-volume.service tgtd.service iscsid.service</code></pre>
</li>
<li>
<p>安装和配置存储节点（ceph RBD）</p>
<p>安装软件包：</p>
<pre class="highlight"><code class="language-shell">$ yum install ceph-common python2-rados python2-rbd python2-keystone openstack-cinder-volume</code></pre>
<p>在[DEFAULT]部分，启用LVM后端，配置镜像服务API的位置。</p>
<pre class="highlight"><code class="language-ini">[DEFAULT]
enabled_backends = ceph-rbd</code></pre>
<p>添加ceph rbd配置部分，配置块命名与enabled_backends中保持一致</p>
<pre class="highlight"><code class="language-ini">[ceph-rbd]
glance_api_version = 2
rados_connect_timeout = -1
rbd_ceph_conf = /etc/ceph/ceph.conf
rbd_flatten_volume_from_snapshot = False
rbd_max_clone_depth = 5
rbd_pool = &lt;RBD_POOL_NAME&gt;  # RBD存储池名称
rbd_secret_uuid = &lt;rbd_secret_uuid&gt; # 随机生成SECRET UUID
rbd_store_chunk_size = 4
rbd_user = &lt;RBD_USER_NAME&gt;
volume_backend_name = ceph-rbd
volume_driver = cinder.volume.drivers.rbd.RBDDriver</code></pre>
<p>配置存储节点ceph客户端，需要保证/etc/ceph/目录中包含ceph集群访问配置，包括ceph.conf以及keyring</p>
<pre class="highlight"><code class="language-shell">[root@openeuler ~]# ll /etc/ceph
-rw-r--r-- 1 root root   82 Jun 16 17:11 ceph.client.&lt;rbd_user&gt;.keyring
-rw-r--r-- 1 root root 1.5K Jun 16 17:11 ceph.conf
-rw-r--r-- 1 root root   92 Jun 16 17:11 rbdmap</code></pre>
<p>在存储节点检查ceph集群是否正常可访问</p>
<pre class="highlight"><code class="language-shell">[root@openeuler ~]# ceph --user cinder -s
  cluster:
    id:     b7b2fac6-420f-4ec1-aea2-4862d29b4059
    health: HEALTH_OK

  services:
    mon: 3 daemons, quorum VIRT01,VIRT02,VIRT03
    mgr: VIRT03(active), standbys: VIRT02, VIRT01
    mds: cephfs_virt-1/1/1 up  {0=VIRT03=up:active}, 2 up:standby
    osd: 15 osds: 15 up, 15 in

  data:
    pools:   7 pools, 1416 pgs
    objects: 5.41M objects, 19.8TiB
    usage:   49.3TiB used, 59.9TiB / 109TiB avail
    pgs:     1414 active

  io:
    client:   2.73MiB/s rd, 22.4MiB/s wr, 3.21kop/s rd, 1.19kop/s wr</code></pre>
<p>启动服务</p>
<pre class="highlight"><code class="language-shell">$ systemctl enable openstack-cinder-volume.service
$ systemctl start openstack-cinder-volume.service</code></pre>
</li>
<li>
<p>安装和配置备份服务</p>
<p>编辑 /etc/cinder/cinder.conf 文件：</p>
<p>在[DEFAULT]部分，配置备份选项</p>
<p><pre class="highlight"><code class="language-ini">[DEFAULT]
# ...
# 注意: openEuler 21.03中没有提供OpenStack Swift软件包，需要用户自行安装。或者使用其他的备份后端，例如，NFS。NFS已经过测试验证，可以正常使用。
backup_driver = cinder.backup.drivers.swift.SwiftBackupDriver
backup_swift_url = SWIFT_URL</code></pre>
替换SWIFT_URL为对象存储服务的URL，该URL可以通过对象存储API端点找到：</p>
<p><pre class="highlight"><code class="language-shell">$ openstack catalog show object-store</code></pre>
完成安装：</p>
<pre class="highlight"><code class="language-shell">$ systemctl enable openstack-cinder-backup.service
$ systemctl start openstack-cinder-backup.service</code></pre>
</li>
<li>
<p>验证</p>
<p>列出服务组件验证每个步骤成功：
<pre class="highlight"><code class="language-shell">$ source admin-openrc
$ openstack volume service list</code></pre></p>
<p>注：目前暂未对swift组件进行支持，有条件的同学可以配置对接ceph。</p>
</li>
</ol>
<h3 id="horizon">Horizon 安装<a class="headerlink" href="#horizon" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>安装软件包</p>
<p><pre class="highlight"><code class="language-shell">$ yum install openstack-dashboard</code></pre>
2. 修改文件<code>/usr/share/openstack-dashboard/openstack_dashboard/local/local_settings.py</code></p>
<p>修改变量 </p>
<p><pre class="highlight"><code class="language-ini">ALLOWED_HOSTS = ['*', ]
OPENSTACK_HOST = "controller"
OPENSTACK_KEYSTONE_URL = "http://%s:5000/v3" % OPENSTACK_HOST
OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True
SESSION_ENGINE = 'django.contrib.sessions.backends.cache'
CACHES = {
    'default': {
         'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache',
         'LOCATION': 'controller:11211',
    }
}</code></pre>
新增变量
<pre class="highlight"><code class="language-ini">OPENSTACK_API_VERSIONS = {
    "identity": 3,
    "image": 2,
    "volume": 3,
}
WEBROOT = "/dashboard/"
COMPRESS_OFFLINE = True
OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = "default"
OPENSTACK_KEYSTONE_DEFAULT_ROLE = "admin"
LOGIN_URL = '/dashboard/auth/login/'
LOGOUT_URL = '/dashboard/auth/logout/'</code></pre>
3. 修改文件/etc/httpd/conf.d/openstack-dashboard.conf
<pre class="highlight"><code class="language-xml">WSGIDaemonProcess dashboard
WSGIProcessGroup dashboard
WSGISocketPrefix run/wsgi
WSGIApplicationGroup %{GLOBAL}

WSGIScriptAlias /dashboard /usr/share/openstack-dashboard/openstack_dashboard/wsgi/django.wsgi
Alias /dashboard/static /usr/share/openstack-dashboard/static

&lt;Directory /usr/share/openstack-dashboard/openstack_dashboard/wsgi&gt;
  Options All
  AllowOverride All
  Require all granted
&lt;/Directory&gt;

&lt;Directory /usr/share/openstack-dashboard/static&gt;
  Options All
  AllowOverride All
  Require all granted
&lt;/Directory&gt;</code></pre>
4. 在/usr/share/openstack-dashboard目录下执行
<pre class="highlight"><code class="language-shell">$ ./manage.py compress</code></pre>
5. 重启 httpd 服务
<pre class="highlight"><code class="language-shell">$ systemctl restart httpd</code></pre>
5. 验证
打开浏览器，输入网址http://<host_ip>，登录 horizon。</p>
</li>
</ol>
<h3 id="tempest">Tempest 安装<a class="headerlink" href="#tempest" title="Permanent link">&para;</a></h3>
<p>Tempest是OpenStack的集成测试服务，如果用户需要全面自动化测试已安装的OpenStack环境的功能,则推荐使用该组件。否则，可以不用安装</p>
<ol>
<li>安装Tempest
    <pre class="highlight"><code class="language-shell">$ yum install openstack-tempest</code></pre></li>
<li>
<p>初始化目录</p>
<p><pre class="highlight"><code class="language-shell">$ tempest init mytest</code></pre>
3. 修改配置文件。</p>
<p><pre class="highlight"><code class="language-shell">$ cd mytest
$ vi etc/tempest.conf</code></pre>
tempest.conf中需要配置当前OpenStack环境的信息，具体内容可以参考<a href="https://docs.openstack.org/tempest/latest/sampleconf.html">官方示例</a></p>
</li>
<li>
<p>执行测试</p>
<pre class="highlight"><code class="language-shell">$ tempest run</code></pre>
</li>
</ol>
<h3 id="ironic">Ironic 安装<a class="headerlink" href="#ironic" title="Permanent link">&para;</a></h3>
<p>Ironic是OpenStack的裸金属服务，如果用户需要进行裸机部署则推荐使用该组件。否则，可以不用安装。</p>
<ol>
<li>设置数据库</li>
</ol>
<p>裸金属服务在数据库中存储信息，创建一个<strong>ironic</strong>用户可以访问的<strong>ironic</strong>数据库，替换<strong>IRONIC_DBPASSWORD</strong>为合适的密码</p>
<pre class="highlight"><code class="language-shell">$ mysql -u root -p </code></pre>
<pre class="highlight"><code class="language-sql">MariaDB [(none)]&gt; CREATE DATABASE ironic CHARACTER SET utf8; 

MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON ironic.* TO 'ironic'@'localhost' \     
IDENTIFIED BY 'IRONIC_DBPASSWORD'; 

MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON ironic.* TO 'ironic'@'%' \     
IDENTIFIED BY 'IRONIC_DBPASSWORD';</code></pre>
<ol>
<li>安装软件包</li>
</ol>
<pre class="highlight"><code class="language-shell">yum install openstack-ironic-api openstack-ironic-conductor python2-ironicclient</code></pre>
<p>启动服务</p>
<pre class="highlight"><code class="language-shell">systemctl enable openstack-ironic-api openstack-ironic-conductor
systemctl start openstack-ironic-api openstack-ironic-conductor</code></pre>
<ol>
<li>组件安装与配置</li>
</ol>
<p>##### 创建服务用户认证</p>
<p>1、创建Bare Metal服务用户</p>
<pre class="highlight"><code class="language-shell">$ openstack user create --password IRONIC_PASSWORD \ 
--email ironic@example.com ironic 
$ openstack role add --project service --user ironic admin 
$ openstack service create --name ironic --description \ 
"Ironic baremetal provisioning service" baremetal </code></pre>
<p>2、创建Bare Metal服务访问入口</p>
<pre class="highlight"><code class="language-shell">$ openstack endpoint create --region RegionOne baremetal admin http://$IRONIC_NODE:6385 
$ openstack endpoint create --region RegionOne baremetal public http://$IRONIC_NODE:6385 
$ openstack endpoint create --region RegionOne baremetal internal http://$IRONIC_NODE:6385 </code></pre>
<p>##### 配置ironic-api服务</p>
<p>配置文件路径/etc/ironic/ironic.conf</p>
<p>1、通过<strong>connection</strong>选项配置数据库的位置，如下所示，替换<strong>IRONIC_DBPASSWORD</strong>为<strong>ironic</strong>用户的密码，替换<strong>DB_IP</strong>为DB服务器所在的IP地址：</p>
<pre class="highlight"><code class="language-ini">[database] 

# The SQLAlchemy connection string used to connect to the 
# database (string value) 

connection = mysql+pymysql://ironic:IRONIC_DBPASSWORD@DB_IP/ironic</code></pre>
<p>2、通过以下选项配置ironic-api服务使用RabbitMQ消息代理，替换<strong>RPC_*</strong>为RabbitMQ的详细地址和凭证</p>
<pre class="highlight"><code class="language-ini">[DEFAULT] 

# A URL representing the messaging driver to use and its full 
# configuration. (string value) 

transport_url = rabbit://RPC_USER:RPC_PASSWORD@RPC_HOST:RPC_PORT/</code></pre>
<p>用户也可自行使用json-rpc方式替换rabbitmq</p>
<p>3、配置ironic-api服务使用身份认证服务的凭证，替换<strong>PUBLIC_IDENTITY_IP</strong>为身份认证服务器的公共IP，替换<strong>PRIVATE_IDENTITY_IP</strong>为身份认证服务器的私有IP，替换<strong>IRONIC_PASSWORD</strong>为身份认证服务中<strong>ironic</strong>用户的密码：</p>
<pre class="highlight"><code class="language-ini">[DEFAULT] 

# Authentication strategy used by ironic-api: one of 
# "keystone" or "noauth". "noauth" should not be used in a 
# production environment because all authentication will be 
# disabled. (string value) 

auth_strategy=keystone 
force_config_drive = True

[keystone_authtoken] 
# Authentication type to load (string value) 
auth_type=password 
# Complete public Identity API endpoint (string value) 
www_authenticate_uri=http://PUBLIC_IDENTITY_IP:5000 
# Complete admin Identity API endpoint. (string value) 
auth_url=http://PRIVATE_IDENTITY_IP:5000 
# Service username. (string value) 
username=ironic 
# Service account password. (string value) 
password=IRONIC_PASSWORD 
# Service tenant name. (string value) 
project_name=service 
# Domain name containing project (string value) 
project_domain_name=Default 
# User's domain name (string value) 
user_domain_name=Default</code></pre>
<p>4、需要在配置文件中指定ironic日志目录</p>
<pre class="highlight"><code>[DEFAULT]
log_dir = /var/log/ironic/</code></pre>
<p>5、创建裸金属服务数据库表</p>
<pre class="highlight"><code class="language-shell">$ ironic-dbsync --config-file /etc/ironic/ironic.conf create_schema</code></pre>
<p>6、重启ironic-api服务</p>
<pre class="highlight"><code class="language-shell">$ systemctl restart openstack-ironic-api</code></pre>
<p>##### 配置ironic-conductor服务</p>
<p>1、替换<strong>HOST_IP</strong>为conductor host的IP</p>
<pre class="highlight"><code class="language-ini">[DEFAULT] 

# IP address of this host. If unset, will determine the IP 
# programmatically. If unable to do so, will use "127.0.0.1". 
# (string value) 

my_ip=HOST_IP</code></pre>
<p>2、配置数据库的位置，ironic-conductor应该使用和ironic-api相同的配置。替换<strong>IRONIC_DBPASSWORD</strong>为<strong>ironic</strong>用户的密码，替换DB_IP为DB服务器所在的IP地址：</p>
<pre class="highlight"><code class="language-ini">[database] 

# The SQLAlchemy connection string to use to connect to the 
# database. (string value) 

connection = mysql+pymysql://ironic:IRONIC_DBPASSWORD@DB_IP/ironic</code></pre>
<p>3、通过以下选项配置ironic-api服务使用RabbitMQ消息代理，ironic-conductor应该使用和ironic-api相同的配置，替换<strong>RPC_*</strong>为RabbitMQ的详细地址和凭证</p>
<pre class="highlight"><code class="language-ini">[DEFAULT] 

# A URL representing the messaging driver to use and its full 
# configuration. (string value) 

transport_url = rabbit://RPC_USER:RPC_PASSWORD@RPC_HOST:RPC_PORT/</code></pre>
<p>用户也可自行使用json-rpc方式替换rabbitmq</p>
<p>4、配置凭证访问其他OpenStack服务</p>
<p>为了与其他OpenStack服务进行通信，裸金属服务在请求其他服务时需要使用服务用户与OpenStack Identity服务进行认证。这些用户的凭据必须在与相应服务相关的每个配置文件中进行配置。</p>
<p>[neutron] - 访问Openstack网络服务 
   [glance] - 访问Openstack镜像服务 
   [swift] - 访问Openstack对象存储服务 
   [cinder] - 访问Openstack块存储服务 
   [inspector] - 访问Openstack裸金属introspection服务 
   [service_catalog] - 一个特殊项用于保存裸金属服务使用的凭证，该凭证用于发现注册在Openstack身份认证服务目录中的自己的API URL端点</p>
<p>简单起见，可以对所有服务使用同一个服务用户。为了向后兼容，该用户应该和ironic-api服务的[keystone_authtoken]所配置的为同一个用户。但这不是必须的，也可以为每个服务创建并配置不同的服务用户。</p>
<p>在下面的示例中，用户访问openstack网络服务的身份验证信息配置为：</p>
<p>网络服务部署在名为RegionOne的身份认证服务域中，仅在服务目录中注册公共端点接口</p>
<p>请求时使用特定的CA SSL证书进行HTTPS连接</p>
<p>与ironic-api服务配置相同的服务用户</p>
<p>动态密码认证插件基于其他选项发现合适的身份认证服务API版本</p>
<pre class="highlight"><code class="language-ini">[neutron] 

# Authentication type to load (string value) 
auth_type = password 
# Authentication URL (string value) 
auth_url=https://IDENTITY_IP:5000/ 
# Username (string value) 
username=ironic 
# User's password (string value) 
password=IRONIC_PASSWORD 
# Project name to scope to (string value) 
project_name=service 
# Domain ID containing project (string value) 
project_domain_id=default 
# User's domain id (string value) 
user_domain_id=default 
# PEM encoded Certificate Authority to use when verifying 
# HTTPs connections. (string value) 
cafile=/opt/stack/data/ca-bundle.pem 
# The default region_name for endpoint URL discovery. (string 
# value) 
region_name = RegionOne 
# List of interfaces, in order of preference, for endpoint 
# URL. (list value) 
valid_interfaces=public</code></pre>
<p>默认情况下，为了与其他服务进行通信，裸金属服务会尝试通过身份认证服务的服务目录发现该服务合适的端点。如果希望对一个特定服务使用一个不同的端点，则在裸金属服务的配置文件中通过endpoint_override选项进行指定：</p>
<pre class="highlight"><code class="language-ini">[neutron] 
# ...
endpoint_override = &lt;NEUTRON_API_ADDRESS&gt;</code></pre>
<p>5、配置允许的驱动程序和硬件类型</p>
<p>通过设置enabled_hardware_types设置ironic-conductor服务允许使用的硬件类型：</p>
<pre class="highlight"><code class="language-ini">[DEFAULT] 
enabled_hardware_types = ipmi </code></pre>
<p>配置硬件接口：</p>
<pre class="highlight"><code class="language-ini">enabled_boot_interfaces = pxe
enabled_deploy_interfaces = direct,iscsi
enabled_inspect_interfaces = inspector
enabled_management_interfaces = ipmitool
enabled_power_interfaces = ipmitool</code></pre>
<p>配置接口默认值：</p>
<pre class="highlight"><code class="language-ini">[DEFAULT]
default_deploy_interface = direct
default_network_interface = neutron</code></pre>
<p>如果启用了任何使用Direct deploy的驱动，必须安装和配置镜像服务的Swift后端。Ceph对象网关(RADOS网关)也支持作为镜像服务的后端。</p>
<p>6、重启ironic-conductor服务</p>
<pre class="highlight"><code class="language-shell">$ systemctl restart openstack-ironic-conductor</code></pre>
<ol>
<li>deploy ramdisk镜像制作</li>
</ol>
<p>目前ramdisk镜像支持通过ironic python agent builder来进行制作，这里介绍下使用这个工具构建ironic使用的deploy镜像的完整过程。（用户也可以根据自己的情况获取ironic-python-agent，这里提供使用ipa-builder制作ipa方法）</p>
<p>##### 安装 ironic-python-agent-builder</p>
<ol>
<li>
<p>安装工具：</p>
<pre class="highlight"><code class="language-shell">$ pip install ironic-python-agent-builder</code></pre>
</li>
<li>
<p>修改以下文件中的python解释器：</p>
<pre class="highlight"><code class="language-shell">$ /usr/bin/yum /usr/libexec/urlgrabber-ext-down</code></pre>
</li>
<li>
<p>安装其它必须的工具：</p>
<pre class="highlight"><code class="language-shell">$ yum install git</code></pre>
<p>由于<code>DIB</code>依赖<code>semanage</code>命令，所以在制作镜像之前确定该命令是否可用：<code>semanage --help</code>，如果提示无此命令，安装即可：</p>
<pre class="highlight"><code class="language-shell"># 先查询需要安装哪个包
[root@localhost ~]# yum provides /usr/sbin/semanage
已加载插件：fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirror.vcu.edu
 * extras: mirror.vcu.edu
 * updates: mirror.math.princeton.edu
policycoreutils-python-2.5-34.el7.aarch64 : SELinux policy core python utilities
源    ：base
匹配来源：
文件名    ：/usr/sbin/semanage
# 安装
[root@localhost ~]# yum install policycoreutils-python</code></pre>
</li>
</ol>
<p>##### 制作镜像</p>
<p>如果是<code>aarch64</code>架构，还需要添加：</p>
<pre class="highlight"><code class="language-shell">$ export ARCH=aarch64</code></pre>
<p>###### 普通镜像</p>
<p>基本用法：</p>
<pre class="highlight"><code class="language-shell">usage: ironic-python-agent-builder [-h] [-r RELEASE] [-o OUTPUT] [-e ELEMENT]
                                   [-b BRANCH] [-v] [--extra-args EXTRA_ARGS]
                                   distribution

positional arguments:
  distribution          Distribution to use

optional arguments:
  -h, --help            show this help message and exit
  -r RELEASE, --release RELEASE
                        Distribution release to use
  -o OUTPUT, --output OUTPUT
                        Output base file name
  -e ELEMENT, --element ELEMENT
                        Additional DIB element to use
  -b BRANCH, --branch BRANCH
                        If set, override the branch that is used for ironic-
                        python-agent and requirements
  -v, --verbose         Enable verbose logging in diskimage-builder
  --extra-args EXTRA_ARGS
                        Extra arguments to pass to diskimage-builder</code></pre>
<p>举例说明：</p>
<pre class="highlight"><code class="language-shell">$ ironic-python-agent-builder centos -o /mnt/ironic-agent-ssh -b origin/stable/rocky</code></pre>
<p>###### 允许ssh登录</p>
<p>初始化环境变量，然后制作镜像：</p>
<pre class="highlight"><code class="language-shell">$ export DIB_DEV_USER_USERNAME=ipa \
$ export DIB_DEV_USER_PWDLESS_SUDO=yes \
$ export DIB_DEV_USER_PASSWORD='123'
$ ironic-python-agent-builder centos -o /mnt/ironic-agent-ssh -b origin/stable/rocky -e selinux-permissive -e devuser</code></pre>
<p>###### 指定代码仓库</p>
<p>初始化对应的环境变量，然后制作镜像：</p>
<pre class="highlight"><code class="language-ini"># 指定仓库地址以及版本
DIB_REPOLOCATION_ironic_python_agent=git@172.20.2.149:liuzz/ironic-python-agent.git
DIB_REPOREF_ironic_python_agent=origin/develop

# 直接从gerrit上clone代码
DIB_REPOLOCATION_ironic_python_agent=https://review.opendev.org/openstack/ironic-python-agent
DIB_REPOREF_ironic_python_agent=refs/changes/43/701043/1</code></pre>
<p>参考：<a href="https://docs.openstack.org/diskimage-builder/latest/elements/source-repositories/README.html">source-repositories</a>。</p>
<p>指定仓库地址及版本验证成功。</p>
<p>在Rocky中，我们还提供了ironic-inspector等服务，用户可根据自身需求安装。</p>
<h3 id="kolla">Kolla 安装<a class="headerlink" href="#kolla" title="Permanent link">&para;</a></h3>
<p>Kolla为OpenStack服务提供生产环境可用的容器化部署的功能。openEuler 20.03 LTS SP2中已经引入了Kolla和Kolla-ansible服务，但是Kolla 以及 Kolla-ansible 原生并不支持 openEuler，
因此 Openstack SIG 在openEuler 20.03 LTS SP3中提供了 <code>openstack-kolla-plugin</code> 和 <code>openstack-kolla-ansible-plugin</code> 这两个补丁包。</p>
<p>Kolla的安装十分简单，只需要安装对应的RPM包即可</p>
<p>支持 openEuler 版本：</p>
<pre class="highlight"><code class="language-shell">yum install openstack-kolla-plugin openstack-kolla-ansible-plugin</code></pre>
<p>不支持 openEuler 版本：</p>
<pre class="highlight"><code class="language-shell">yum install openstack-kolla openstack-kolla-ansible</code></pre>
<p>安装完后，就可以使用<code>kolla-ansible</code>, <code>kolla-build</code>, <code>kolla-genpwd</code>, <code>kolla-mergepwd</code>等命令了。</p>
<h3 id="trove">Trove 安装<a class="headerlink" href="#trove" title="Permanent link">&para;</a></h3>
<p>Trove是OpenStack的数据库服务，如果用户使用OpenStack提供的数据库服务则推荐使用该组件。否则，可以不用安装。</p>
<ol>
<li>设置数据库</li>
</ol>
<p>数据库服务在数据库中存储信息，创建一个<strong>trove</strong>用户可以访问<strong>trove</strong>数据库，替换<strong>TROVE_DBPASSWORD</strong>为对应密码</p>
<pre class="highlight"><code class="language-shell">$ mysql -u root -p</code></pre>
<pre class="highlight"><code class="language-sql">MariaDB [(none)]&gt; CREATE DATABASE trove CHARACTER SET utf8;
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON trove.* TO 'trove'@'localhost' \
IDENTIFIED BY 'TROVE_DBPASSWORD';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON trove.* TO 'trove'@'%' \
IDENTIFIED BY 'TROVE_DBPASSWORD';</code></pre>
<ol>
<li>创建服务用户认证</li>
</ol>
<p>1、创建<strong>Trove</strong>服务用户</p>
<p><pre class="highlight"><code class="language-shell">$ openstack user create --password TROVE_PASSWORD \
                      --email trove@example.com trove
$ openstack role add --project service --user trove admin
$ openstack service create --name trove
                         --description "Database service" database</code></pre>
   <strong>解释：</strong> <code>TROVE_PASSWORD</code> 替换为<code>trove</code>用户的密码</p>
<p>2、创建<strong>Database</strong>服务访问入口</p>
<p><pre class="highlight"><code class="language-shell">$ openstack endpoint create --region RegionOne database public http://$TROVE_NODE:8779/v1.0/%\(tenant_id\)s
$ openstack endpoint create --region RegionOne database internal http://$TROVE_NODE:8779/v1.0/%\(tenant_id\)s
$ openstack endpoint create --region RegionOne database admin http://$TROVE_NODE:8779/v1.0/%\(tenant_id\)s</code></pre>
   <strong>解释：</strong> <code>$TROVE_NODE</code> 替换为Trove的API服务部署节点</p>
<ol>
<li>安装和配置<strong>Trove</strong>各组件</li>
</ol>
<p>1、安装<strong>Trove</strong>包</p>
<p><pre class="highlight"><code class="language-shell">$ yum install openstack-trove python2-troveclient</code></pre>
   2、配置<code>/etc/trove/trove.conf</code></p>
<p><pre class="highlight"><code class="language-ini">[DEFAULT]
bind_host=TROVE_NODE_IP
log_dir = /var/log/trove

auth_strategy = keystone
# Config option for showing the IP address that nova doles out
add_addresses = True
network_label_regex = ^NETWORK_LABEL$
api_paste_config = /etc/trove/api-paste.ini

trove_auth_url = http://controller:35357/v3/
nova_compute_url = http://controller:8774/v2
cinder_url = http://controller:8776/v1

nova_proxy_admin_user = admin
nova_proxy_admin_pass = ADMIN_PASS
nova_proxy_admin_tenant_name = service
taskmanager_manager = trove.taskmanager.manager.Manager
use_nova_server_config_drive = True

# Set these if using Neutron Networking
network_driver=trove.network.neutron.NeutronDriver
network_label_regex=.*
transport_url = rabbit://openstack:RABBIT_PASS@controller:5672/

[database]
connection = mysql+pymysql://trove:TROVE_DBPASS@controller/trove

[keystone_authtoken]
www_authenticate_uri = http://controller:5000/v3/
auth_url=http://controller:35357/v3/
#auth_uri = http://controller/identity
#auth_url = http://controller/identity_admin
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = trove
password = TROVE_PASS
</code></pre>
   <strong>解释：</strong>
   - <code>[Default]</code>分组中<code>bind_host</code>配置为Trove部署节点的IP
   - <code>nova_compute_url</code> 和 <code>cinder_url</code> 为Nova和Cinder在Keystone中创建的endpoint
   - <code>nova_proxy_XXX</code> 为一个能访问Nova服务的用户信息，上例中使用<code>admin</code>用户为例
   - <code>transport_url</code> 为<code>RabbitMQ</code>连接信息，<code>RABBIT_PASS</code>替换为RabbitMQ的密码
   - <code>[database]</code>分组中的<code>connection</code> 为前面在mysql中为Trove创建的数据库信息
   - Trove的用户信息中<code>TROVE_PASS</code>替换为实际trove用户的密码  </p>
<p>3、配置<code>/etc/trove/trove-taskmanager.conf</code></p>
<p><pre class="highlight"><code class="language-ini">[DEFAULT]
log_dir = /var/log/trove
trove_auth_url = http://controller/identity/v2.0
nova_compute_url = http://controller:8774/v2
cinder_url = http://controller:8776/v1
transport_url = rabbit://openstack:RABBIT_PASS@controller:5672/

[database]
connection = mysql+pymysql://trove:TROVE_DBPASS@controller/trove</code></pre>
   <strong>解释：</strong> 参照<code>trove.conf</code>配置
   4、配置<code>/etc/trove/trove-conductor.conf</code></p>
<p><pre class="highlight"><code class="language-ini">[DEFAULT]
log_dir = /var/log/trove
trove_auth_url = http://controller/identity/v2.0
nova_compute_url = http://controller:8774/v2
cinder_url = http://controller:8776/v1
transport_url = rabbit://openstack:RABBIT_PASS@controller:5672/

[database]
connection = mysql+pymysql://trove:trove@controller/trove</code></pre>
   <strong>解释：</strong> 参照<code>trove.conf</code>配置</p>
<p>5、配置<code>/etc/trove/trove-guestagent.conf</code></p>
<p><pre class="highlight"><code class="language-ini">[DEFAULT]
rabbit_host = controller
rabbit_password = RABBIT_PASS
nova_proxy_admin_user = admin
nova_proxy_admin_pass = ADMIN_PASS
nova_proxy_admin_tenant_name = service
trove_auth_url = http://controller/identity_admin/v2.0</code></pre>
   <strong>解释：</strong> <code>guestagent</code>是trove中一个独立组件，需要预先内置到Trove通过Nova创建的虚拟
   机镜像中，在创建好数据库实例后，会起guestagent进程，负责通过消息队列（RabbitMQ）向Trove上
   报心跳，因此需要配置RabbitMQ的用户和密码信息。</p>
<p>6、生成数据<code>Trove</code>数据库表</p>
<pre class="highlight"><code class="language-shell">$ su -s /bin/sh -c "trove-manage db_sync" trove</code></pre>
<ol>
<li>完成安装配置
   1、配置<strong>Trove</strong>服务自启动</li>
</ol>
<p><pre class="highlight"><code class="language-shell">$ systemctl enable openstack-trove-api.service \
openstack-trove-taskmanager.service \
openstack-trove-conductor.service </code></pre>
   2、启动服务</p>
<pre class="highlight"><code class="language-shell">$ systemctl start openstack-trove-api.service \
openstack-trove-taskmanager.service \
openstack-trove-conductor.service</code></pre>
<h3 id="rally">Rally 安装<a class="headerlink" href="#rally" title="Permanent link">&para;</a></h3>
<p>Rally是OpenStack提供的性能测试工具。只需要简单的安装即可。</p>
<pre class="highlight"><code>yum install openstack-rally openstack-rally-plugins</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="页脚导航">
        <a href="../OpenStack-queens/" class="btn btn-neutral float-left" title="openEuler-20.03-LTS-SP3_Queens"><span class="icon icon-circle-arrow-left"></span> 上一章</a>
        <a href="../OpenStack-train/" class="btn btn-neutral float-right" title="openEuler-20.03-LTS-SP3_Train">下一章 <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  用<a href="https://www.mkdocs.org/">MkDocs</a>构建，使用<a href="https://readthedocs.org">Read the Docs</a>提供的<a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>。
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="版本">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../OpenStack-queens/" style="color: #fcfcfc">&laquo; 上一章</a></span>
    
    
      <span><a href="../OpenStack-train/" style="color: #fcfcfc">下一章 &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
